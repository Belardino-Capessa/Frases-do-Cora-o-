<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Histórias do Coração - Categorias</title>
    
    <link href="assets/fontawesome/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="assets/css/estilo-global.css">

<script src="assets/js/config-global.js"></script>
    
    <script>
    (function() {
        // Busca a preferência salva (padrão 100% se não existir)
        const fonteSalva = localStorage.getItem('appFontePerc') || '100';
        
        // Calcula o valor em pixels (16px * percentagem)
        const tamanhoCalculado = (fonteSalva / 100) * 16;
        
        // Aplica imediatamente ao root antes da página renderizar (evita o "pulo" visual)
        document.documentElement.style.setProperty('--fonte-base', tamanhoCalculado + 'px');
    })();
</script>
    <script>
        // --- VARIÁVEIS DE CONFIGURAÇÃO E DADOS (IGUAL À TELA CATEGORIAS) ---
        const themeKey = 'appTheme';
        const corKey = 'appCorDestaque';
        const fundoKey = 'appCorFundo';
        const corTextoKey = 'appCorTexto';
        const corPadrao = '#e91e63'; 
        const fundoPadrao = '#eef2f5'; 
        const corTextoPadrao = '#1c274b'; 
        
        const KEY_VIBRACAO = 'prefVibracao';
        const KEY_SOM = 'prefSomClique';
        const KEY_FAVORITOS = 'historiasFavoritas';
        const KEY_HISTORICO = 'historiasHistorico';
        const KEY_LAYOUT = 'prefLayoutAtivo';

        const HISTORIAS_URL = 'assets/frases/historias.json'; 
        let allFrasesData = []; 
        let allCategories = []; 
        let currentCategory = null; 
        let currentLayout = localStorage.getItem(KEY_LAYOUT) || 'list'; 
        let listaAtualParaLeitura = []; 

        /** Aplica as configurações de tema e cor salvas no localStorage. */
        function loadSettings() {
            const savedTheme = localStorage.getItem(themeKey);
            const savedDestaque = localStorage.getItem(corKey);
            const savedFundo = localStorage.getItem(fundoKey);
            const savedTexto = localStorage.getItem(corTextoKey);
            
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let isDarkMode = (savedTheme === 'dark') || (!savedTheme && prefersDark);
            
            if (document.body) {
                if (isDarkMode) document.body.classList.add('theme-escuro');
                else document.body.classList.remove('theme-escuro');
            }
            
            const finalFundo = savedFundo || (isDarkMode ? '#121212' : fundoPadrao);
            const finalTexto = savedTexto || (isDarkMode ? '#f0f0f0' : corTextoPadrao);

            document.documentElement.style.setProperty('--cor-destaque', savedDestaque || corPadrao);
            document.documentElement.style.setProperty('--cor-fundo-principal', finalFundo);
            document.documentElement.style.setProperty('--cor-texto-principal', finalTexto);
        }
        loadSettings();
    </script>

    <style>
        /* FONTE ORIGINAL */
        @font-face {
            font-family: 'Nunito';
            src: url('../assets/fontes/Nunito-VariableFont_wght.ttf') format('truetype');
            font-weight: 100 900;
        }

        :root {
            --cor-fundo-principal: #eef2f5; --cor-texto-principal: #1c274b; --cor-card-fundo: #ffffff; --cor-destaque: #e91e63;
            --cor-sombra: rgba(28, 39, 75, 0.15); --cor-glass-fundo: rgba(255, 255, 255, 0.25); --cor-glass-borda: rgba(255, 255, 255, 0.7);
            --cor-particula-1: var(--cor-destaque); --cor-particula-2: var(--cor-texto-principal); --fonte-base: 16px; --borda-raio: 1.5rem; --duracao-animacao: 0.5s;
        }
        .theme-escuro {
            --cor-fundo-principal: #121212; --cor-texto-principal: #f0f0f0; --cor-card-fundo: #1e1e1e; --cor-sombra: rgba(0, 0, 0, 0.5);
            --cor-glass-fundo: rgba(255, 255, 255, 0.05); --cor-glass-borda: rgba(255, 255, 255, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Nunito', sans-serif; background-color: var(--cor-fundo-principal); color: var(--cor-texto-principal);
            min-height: 100vh; transition: background-color var(--duracao-animacao), color var(--duracao-animacao);
            padding-top: 5rem; padding-bottom: 3rem; 
        }
        .container { width: 100%; max-width: 100%; margin: 0 auto; padding: 1.5rem; position: relative; z-index: 10; }

        /* FUNDO ANIMADO */
        .fundo-animado { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .fundo-animado::before, .fundo-animado::after { content: ''; position: absolute; width: 15rem; height: 15rem; border-radius: 50%; opacity: 0.3; animation: flutuar 20s infinite ease-in-out; pointer-events: none; }
        .fundo-animado::before { background-color: var(--cor-particula-1); top: 10vh; left: 5vw; }
        .fundo-animado::after { background-color: var(--cor-particula-2); bottom: 15vh; right: 5vw; animation-delay: -10s; }
        @keyframes flutuar { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(15vw, 15vh) scale(1.1); } }

        /* CABEÇALHO PRINCIPAL */
        .cabecalho-principal {
            display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 50%; transform: translateX(-50%); 
            width: 100%; max-width: 95%; padding: 1rem 1.5rem; background-color: var(--cor-fundo-principal); 
            box-shadow: 0 2px 10px var(--cor-sombra); z-index: 50; border-radius: 1.5rem; margin-top: 1rem;
        }
        .header-center { display: flex; align-items: center; gap: 10px; position: absolute; left: 50%; transform: translateX(-50%); pointer-events: none;}
        .header-center h1 { font-size: 1.5rem; color: var(--cor-destaque); font-weight: 800; white-space: nowrap; margin: 0; }
        .header-center i { font-size: 1.4rem; color: var(--cor-destaque); animation: pulse 3s infinite; }
        
        .btn-voltar { background: none; border: none; color: var(--cor-texto-principal); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; z-index: 51; transition: all 0.2s; border-radius: 50%; }

        /* CONTROLES DE LAYOUT */
        .layout-controls { display: none; gap: 8px; z-index: 51; }
        .btn-layout { background: none; border: none; color: var(--cor-texto-principal); opacity: 0.4; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        .btn-layout.active { opacity: 1; color: var(--cor-destaque); }

        .mode-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 12px !important; }
        .mode-compact .frase-card { padding: 0.8rem; }

        /* NOVO GRID DE CATEGORIAS COM IMAGEM */
        .grid-categorias { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; padding-top: 1rem; }
        
        .categoria-card {
            position: relative; height: 180px; border-radius: var(--borda-raio); overflow: hidden;
            border: 1px solid var(--cor-glass-borda); display: flex; align-items: flex-end;
            cursor: pointer; box-shadow: 0 4px 12px var(--cor-sombra); transition: transform 0.2s;
        }
        .categoria-card:active { transform: scale(0.96); }
        
        .card-img-fundo {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-size: cover; background-position: center; z-index: 1; transition: 0.5s;
        }
        .card-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.3) 50%, transparent 100%); z-index: 2; 
        }
        .card-info { position: relative; z-index: 3; padding: 1.2rem 0.8rem; color: #fff; width: 100%; }
        .card-info i { color: var(--cor-destaque); font-size: 1.2rem; margin-bottom: 4px; }
        .card-info p { font-weight: 800; font-size: 1rem; margin: 0; line-height: 1.2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .card-info small { font-size: 0.7rem; opacity: 0.8; font-weight: 400; display: block; margin-top: 2px; }
        
        .categoria-contador {
            position: absolute; top: 10px; right: 10px; background-color: var(--cor-destaque);
            color: #fff; font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 10px; z-index: 4;
        }

        /* LISTA DE FRASES / HISTÓRIAS */
        .frases-lista { display: none; flex-direction: column; gap: 1.5rem; padding-top: 1rem; opacity: 0; transition: opacity 0.3s; }
        .frases-lista.active { display: flex; opacity: 1; }

        .frase-card {
            background: var(--cor-glass-fundo); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); 
            border: 1px solid var(--cor-glass-borda); box-shadow: 0 0.5rem 2rem 0 rgba(31, 38, 135, 0.1);
            padding: 1.5rem; border-radius: var(--borda-raio); position: relative;
        }

        .frase-badge-categoria {
            display: inline-flex; align-items: center; gap: 6px; background: rgba(var(--cor-destaque-rgb, 233, 30, 99), 0.1);
            color: var(--cor-destaque); padding: 5px 12px; border-radius: 20px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
        }

        .frase-texto { font-size: 1.2rem; font-style: italic; margin-bottom: 0.75rem; line-height: 1.5; margin-top: 1rem; }
        .frase-autor { display: block; text-align: right; font-size: 0.9rem; font-weight: 600; opacity: 0.7; padding-bottom: 1rem; border-bottom: 1px dashed var(--cor-glass-borda); }

        .frase-acoes { display: flex; justify-content: space-around; padding-top: 1rem; }
        .btn-acao { background: none; border: none; color: var(--cor-texto-principal); cursor: pointer; font-size: 1.4rem; padding: 0.5rem; transition: color 0.2s; }
        .btn-favoritar.favoritado i { color: var(--cor-destaque) !important; font-weight: 900 !important; }

        /* PESQUISA */
        .search-container { position: relative; margin-bottom: 1.5rem; padding-top: 0.5rem; }
        #search-bar {
            width: 100%; padding: 0.75rem 3rem 0.75rem 2.5rem; border: 1px solid var(--cor-glass-borda);
            border-radius: 1rem; background-color: var(--cor-glass-fundo); color: var(--cor-texto-principal);
            font-size: 1rem; box-shadow: 0 2px 8px var(--cor-sombra);
        }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--cor-destaque); }
        .suggestions-box {
            position: absolute; width: 100%; max-height: 250px; overflow-y: auto; background: var(--cor-card-fundo);
            border: 1px solid var(--cor-glass-borda); border-radius: 0 0 1rem 1rem; box-shadow: 0 8px 16px var(--cor-sombra); z-index: 40; top: 100%; display: none;
        }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--cor-glass-borda); }

        /* BOTÃO FLUTUANTE INDEX */
        .btn-flutuante {
            position: fixed; bottom: 2rem; right: 1.5rem; width: 3.5rem; height: 3.5rem;
            border-radius: 50%; background: var(--cor-destaque); color: white; border: none;
            font-size: 1.5rem; z-index: 100; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px var(--cor-sombra);
        }
        
        /* BOTÃO JOGAR ALEATÓRIO (Posicionado acima do seu .btn-flutuante) */
.btn-aleatorio {
    position: fixed; 
    bottom: 6.5rem; /* Ajustado para não sobrepor o de 2rem */
    right: 1.5rem; 
    width: 3.5rem; 
    height: 3.5rem;
    border-radius: 50%; 
    background: ; 
    color: var(--cor-destaque); 
    border: 2px solid var(--cor-destaque);
    font-size: 1.5rem; 
    z-index: 100; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    box-shadow: 0 4px 15px var(--cor-sombra);
    transition: transform 0.2s;
}

.btn-aleatorio:active {
    transform: scale(0.9);
}

/* --- MODO LEITURA --- */
.reader-mode {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100vh; 
    background: var(--cor-fundo-principal);
    z-index: 9999; 
    display: block;
    overflow: hidden; /* O scroll será controlado pela div interna */
    animation: fadeInApp 0.4s ease-out forwards;
}

/* Header Fixo (Banner + Título + Autor) */
.reader-fixed-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 10005;
    background: var(--cor-fundo-principal);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    padding-bottom: 15px;
}

/* Banner dentro do header fixo */
.reader-banner {
    width: 100%;
    height: 15vh;
    background-size: cover;
    background-position: center;
    opacity: 0.4;
    mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    pointer-events: none;
}

.reader-close { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    background: rgba(0,0,0,0.2); 
    border: none; 
    color: var(--cor-destaque); 
    font-size: 1.5rem; 
    z-index: 10010;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    backdrop-filter: blur(5px);
}

.reader-counter { 
    position: absolute; 
    top: 25px; 
    left: 50%; 
    transform: translateX(-50%); 
    font-size: 0.8rem; 
    opacity: 0.5; 
    color: var(--cor-destaque); 
    z-index: 10010;
}

/* Área de Scroll do Conteúdo */
.reader-content-scroll {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    /* Padding superior para o texto não começar atrás do header fixo */
    padding: 28vh 1.5rem 15vh 1.5rem; 
    box-sizing: border-box;
    text-align: center;
}

.reader-story-body {
    max-width: 700px;
    margin: 0 auto;
    font-size: 1.35rem;
    line-height: 1.8;
    color: var(--cor-texto-principal);
    text-align: center;
}

/* Barra de Ações Fixa */
.reader-actions {
    position: fixed !important;
    bottom: 30px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    display: flex !important;
    gap: 25px !important;
    background: var(--cor-destaque) !important;
    padding: 12px 35px !important;
    border-radius: 50px !important;
    z-index: 10010 !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease !important;
}

.btn-reader-acao {
    background: none !important;
    border: none !important;
    color: #ffffff !important;
    font-size: 1.4rem !important;
    cursor: pointer !important;
}

.btn-reader-acao.fav-active i { color: var(--cor-destaque) !important; }

/* Estados Ocultos (Interface Clean ao ler) */
.ui-hidden {
    transform: translateY(-100%); /* Sobe o header */
    opacity: 0;
}
.ui-hidden-actions {
    transform: translateX(-50%) translateY(150%) !important; /* Desce o footer */
    opacity: 0 !important;
}

@keyframes fadeInApp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.reader-fixed-header {
    /* Adicione estas linhas ao que já existe no seu .reader-fixed-header */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

/* Linha de progresso no topo */
.reading-progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.1);
    z-index: 10020;
}

.reading-progress-bar {
    height: 100%;
    background: var(--cor-destaque);
    width: 0%; /* Começa em 0 */
    transition: width 0.1s ease;
}

/* Menu flutuante de ajuste de fonte */
.font-settings-popup {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--cor-destaque);
    padding: 15px 25px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
    z-index: 10020;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
}

.font-settings-popup.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

.btn-font-control {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-font-control:active { transform: scale(0.9); }

.font-size-indicator {
    color: white;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

/* --- MODO LEITURA PREMIUM --- */
.reader-mode {
    position: fixed; top: 0; left: 0; width: 100%; height: 100vh; 
    background: var(--cor-fundo-principal); z-index: 9999; 
    overflow: hidden; animation: fadeInApp 0.4s ease-out forwards;
    transition: background-color 0.3s ease;
}

/* Temas de Cor */
.reader-mode.theme-sepia { background-color: #f4ecd8 !important; }
.reader-mode.theme-sepia .reader-story-body { color: #5b4636 !important; }
.reader-mode.theme-sepia .reader-fixed-header { background-color: #f4ecd8 !important; }

.reader-mode.theme-dark { background-color: #121212 !important; }
.reader-mode.theme-dark .reader-story-body { color: #e0e0e0 !important; }
.reader-mode.theme-dark .reader-fixed-header { background-color: #121212 !important; }

/* Header e Banner */
.reader-fixed-header {
    position: fixed; top: 0; left: 0; width: 100%; z-index: 10005;
    background: var(--cor-fundo-principal); padding-bottom: 15px;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}

.reader-banner {
    width: 100%; height: 15vh; background-size: cover; background-position: center;
    opacity: 0.4; mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
}

/* Área de Texto */
.reader-content-scroll {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto; padding: 28vh 1.5rem 15vh 1.5rem; box-sizing: border-box;
}

.reader-story-body {
    max-width: 650px; margin: 0 auto; text-align: center;
    line-height: 1.8; transition: font-size 0.2s ease;
}

/* UI Elements */
.reader-actions {
    position: fixed !important; bottom: 30px !important; left: 50% !important;
    transform: translateX(-50%) !important; display: flex !important; gap: 15px !important;
    background: var(--cor-destaque) !important; padding: 12px 25px !important;
    border-radius: 50px !important; z-index: 10010 !important;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease !important;
}

.reading-progress-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 4px;
    background: rgba(255,255,255,0.1); z-index: 10020;
}
.reading-progress-bar { height: 100%; background: var(--cor-destaque); width: 0%; }

/* Popups de Ajuste */
.reader-popup {
    position: fixed; bottom: 95px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--cor-destaque); padding: 12px 20px; border-radius: 40px;
    display: flex; align-items: center; gap: 15px; z-index: 10015;
    opacity: 0; pointer-events: none; transition: all 0.3s ease;
}
.reader-popup.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

.ui-hidden { transform: translateY(-100%); opacity: 0; }
.ui-hidden-actions { transform: translateX(-50%) translateY(150%) !important; opacity: 0 !important; }

/* Botões de Círculo para os Temas - O QUE ESTAVA FALTANDO */
.btn-theme-dot {
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    min-height: 32px !important;
    border-radius: 50% !important;
    border: 2px solid rgba(255,255,255,0.4) !important;
    cursor: pointer !important;
    flex-shrink: 0 !important;
    transition: transform 0.2s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn-theme-dot:active {
    transform: scale(0.8);
}

/* Botões de Fonte dentro do popup */
.btn-font-control {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.font-size-indicator {
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    min-width: 40px;
    text-align: center;
}

/* Estado Vazio (Filtros ou Busca) */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--cor-texto-principal);
    animation: fadeIn 0.5s ease-out;
}

.empty-state i {
    color: var(--cor-destaque);
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.1));
    margin-bottom: 20px;
}

/* Animação de entrada dos cards para o Render */
@keyframes cardEntrada {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.frase-card, .story-card {
    animation: cardEntrada 0.4s ease forwards;
    opacity: 0; /* Começa invisível para a animação de delay funcionar */
}

/* Transição de Layout (Grid <=> Lista) */
.lista-historias {
    transition: opacity 0.2s ease-in-out;
}
    </style>
</head>
<body>
    <div class="fundo-animado"></div>
    <div id="toast-container"></div>

    <header class="cabecalho-principal">
        <button onclick="goBack()" class="btn-voltar ripple">
            <i class="fas fa-arrow-left"></i>
        </button>
        
        <div class="header-center">
            <i id="header-icon" class="fas fa-book-open"></i>
            <h1 id="header-titulo">Histórias</h1>
        </div>

        <div class="layout-controls" id="layout-controls">
            <button class="btn-layout ripple" id="btn-layout-list" onclick="setLayout('list')">
                <i class="fas fa-bars"></i>
            </button>
            <button class="btn-layout ripple" id="btn-layout-grid" onclick="setLayout('grid')">
                <i class="fas fa-th-large"></i>
            </button>
        </div>
        <div id="header-spacer" style="width: 2.5rem;"></div>
    </header>

    <div class="container">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search-bar" placeholder="Buscar histórias, temas ou categorias..." autocomplete="off">
            <button id="clear-search" class="btn-acao" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); display: none; opacity: 0.5;">
                <i class="fas fa-times"></i>
            </button>
            <div id="suggestions-box" class="suggestions-box"></div>
        </div>

        <section id="categorias-grid" class="grid-categorias"></section>

        <section id="frases-lista" class="frases-lista"></section>
    </div>

    <button id="btn-random" class="btn-flutuante ripple" title="História Aleatória">
        <i class="fas fa-dice"></i>
    </button>

    <script>
// --- MAPEAMENTO DE ÍCONES E IMAGENS (EXPANDIDO) ---
    const iconMap = {
        "Infantis": "fas fa-child-reaching",
        "Bíblicas": "fas fa-bible",
        "Romance": "fas fa-heart",
        "Terror": "fas fa-ghost",
        "Reflexão": "fas fa-brain",
        "Aventura": "fas fa-compass",
        "Mitologia": "fas fa-dragon",
        "Ficção": "fas fa-rocket",
        "Fábulas": "fas fa-feather",
        "Suspense": "fas fa-user-secret",
        "Histórias Reais": "fas fa-user-check",
        "Contos de Fadas": "fas fa-wand-sparkles",
        "Mistério": "fas fa-magnifying-glass",
        "Humor": "fas fa-face-grin-tears",
        "Lendas": "fas fa-scroll",
        "Drama": "fas fa-masks-theater",
        "default": "fas fa-book-open"
    };

    const imgMap = {
        "Infantis": "assets/imagem/infantis.jpg",
        "Bíblicas": "assets/imagem/biblicas.jpg",
        "Romance": "assets/imagem/romance.jpg",
        "Terror": "assets/imagem/terror.jpg",
        "Reflexão": "assets/imagem/reflexao.jpg",
        "Aventura": "assets/imagem/aventura.jpg",
        "Mitologia": "assets/imagem/mitologia.jpg",
        "Ficção": "assets/imagem/ficcao.jpg",
        "Fábulas": "assets/imagem/fabulas.jpg",
        "Suspense": "assets/imagem/suspense.jpg",
        "Histórias Reais": "assets/imagem/reais.jpg",
        "Contos de Fadas": "assets/imagem/fadas.jpg",
        "Mistério": "assets/imagem/misterio.jpg",
        "Humor": "assets/imagem/humor.jpg",
        "Lendas": "assets/imagem/lendas.jpg",
        "Drama": "assets/imagem/drama.jpg",
        "default": "assets/imagem/default_story.jpg"
    };

    // --- ELEMENTOS DOM ---
    const dom = {
        grid: document.getElementById('categorias-grid'),
        listaFrases: document.getElementById('frases-lista'),
        headerTitulo: document.getElementById('header-titulo'),
        headerIcon: document.getElementById('header-icon'),
        headerSpacer: document.getElementById('header-spacer'),
        layoutControls: document.getElementById('layout-controls'),
        pageTitle: document.getElementById('page-title'),
        searchBar: document.getElementById('search-bar'),
        suggestionsBox: document.getElementById('suggestions-box'),
        clearSearchBtn: document.getElementById('clear-search'),
    };

    // --- GERENCIAMENTO DE DADOS ---

    function getSavedItems(key) {
        try {
            const json = localStorage.getItem(key);
            return json ? JSON.parse(json) : [];
        } catch (e) { return []; }
    }

    function saveItems(key, items) {
        try { localStorage.setItem(key, JSON.stringify(items)); } catch (e) {}
    }
    /** Adiciona um item ao histórico (limite de 30 itens). */
function addToHistorico(item) {
    if (!item || !item.texto) return;
    
    let historico = getSavedItems(KEY_HISTORICO);
    
    // Remove duplicatas baseadas no texto para manter o mais recente no topo
    const filtered = historico.filter(h => h.texto !== item.texto);
    
    // Adiciona ao início com o tempo de visualização
    filtered.unshift({ 
        ...item, 
        dataVisualizacao: new Date().toISOString(),
        timestamp: Date.now() 
    });
    
    // Salva apenas os últimos 30
    saveItems(KEY_HISTORICO, filtered.slice(0, 30));
}

/** Verifica se o item do histórico já está nos favoritos. */
function isFavorited(item) {
    const favoritos = getSavedItems(KEY_FAVORITOS);
    // Comparação por texto e autor para precisão
    return favoritos.some(fav => fav.texto === item.texto && fav.autor === item.autor);
}

/** Adiciona/Remove favoritos com feedback visual do CustomModal. */
function toggleFavorite(item) {
    let favoritos = getSavedItems(KEY_FAVORITOS);
    const index = favoritos.findIndex(fav => fav.texto === item.texto && fav.autor === item.autor);
    const agoraEhFavorito = (index === -1);

    if (agoraEhFavorito) {
        favoritos.push({ ...item, dataFavorito: new Date().toISOString() });
    } else {
        favoritos.splice(index, 1);
    }
    
    saveItems(KEY_FAVORITOS, favoritos);

    // Feedback visual usando seu Modal Global
    window.CustomModal.show({
        titulo: agoraEhFavorito ? "Favoritada!" : "Removida",
        mensagem: agoraEhFavorito ? "Frase salva na sua lista de favoritos." : "Frase removida dos favoritos.",
        icone: agoraEhFavorito ? "fa-heart" : "fa-heart-broken"
    });

    return agoraEhFavorito;
}

    // --- FEEDBACK E UI ---

    function triggerHapticFeedback(pattern = 20) {
        if (navigator.vibrate && localStorage.getItem(KEY_VIBRACAO) !== 'false') {
            navigator.vibrate(pattern);
        }
    }

    function playClickSound() {
        if (localStorage.getItem(KEY_SOM) !== 'false') {
            const sound = new Audio('assets/sound/click.mp3');
            sound.volume = 0.4;
            sound.play().catch(() => {});
        }
    }

    function showToast(mensagem) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = mensagem;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2500);
    }

    function applyRippleEffect(e) {
        const target = e.currentTarget;
        triggerHapticFeedback(20);
        playClickSound();

        const rect = target.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        const x = clientX - rect.left - size / 2;
        const y = clientY - rect.top - size / 2;

        const ripple = document.createElement('span');
        ripple.className = 'ripple-effect';
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px'; ripple.style.top = y + 'px';
        
        target.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
    }

// --- NAVEGAÇÃO INTERNA (TROCA DE TELA) ---

    function goBack() {
        if (currentCategory || dom.searchBar.value) {
            clearSearch();
        } else {
            window.location.href = 'index.html'; 
        }
    }

    function showCategoriasGrid() {
        currentCategory = null;
        dom.headerTitulo.textContent = 'Histórias';
        dom.headerIcon.className = 'fas fa-book-open';
        dom.pageTitle.textContent = 'Histórias do Coração - Categorias';
        
        dom.layoutControls.style.display = 'none';
        dom.headerSpacer.style.display = 'block';

        dom.listaFrases.classList.remove('active');
        dom.listaFrases.innerHTML = '';
        dom.grid.style.display = 'grid';
        setTimeout(() => { dom.grid.style.opacity = '1'; }, 10);
        renderCategoriasGrid(allFrasesData); 
    }

    function navigateToFrases(categoria) {
        currentCategory = categoria;
        dom.headerTitulo.textContent = categoria;
        dom.headerIcon.className = iconMap[categoria] || iconMap['default'];
        dom.pageTitle.textContent = `Histórias | ${categoria}`;
        
        dom.layoutControls.style.display = 'flex';
        dom.headerSpacer.style.display = 'none';
        
        clearSuggestions();
        dom.searchBar.value = ''; 
        
        dom.grid.style.display = 'none';
        dom.listaFrases.classList.add('active');
        filterAndRenderFrasesOnPage(categoria);
    }

    // --- PESQUISA E SUGESTÕES ---
    
    function updateSuggestions(query) {
        query = query.trim().toLowerCase();
        dom.suggestionsBox.innerHTML = '';
        
        if (query.length < 2) {
            dom.suggestionsBox.style.display = 'none';
            dom.clearSearchBtn.style.display = 'none';
            return;
        }

        dom.clearSearchBtn.style.display = 'block';
        const matchedCats = allCategories.filter(cat => cat.toLowerCase().includes(query));
        
        matchedCats.slice(0, 3).forEach(cat => renderSuggestionItem(cat, 'category', cat));

        // AJUSTADO: Usando S.Texto e S.Autor
        const matchedStories = allFrasesData.filter(s => 
            (s.Texto && s.Texto.toLowerCase().includes(query)) || 
            (s.Autor && s.Autor.toLowerCase().includes(query)) ||
            (s.Titulo && s.Titulo.toLowerCase().includes(query))
        );
        
        matchedStories.slice(0, 5).forEach(s => {
            let display = s.Titulo || (s.Texto.length > 50 ? s.Texto.substring(0, 50) + '...' : s.Texto);
            renderSuggestionItem(display, 'phrase', s.Texto, s);
        });
        
        dom.suggestionsBox.style.display = 'block';
    }

    function renderSuggestionItem(display, type, value, fullData = null) {
        const item = document.createElement('div');
        item.className = `suggestion-item`;
        item.innerHTML = `<i class="${type==='category'?'fas fa-folder':'fas fa-book'}"></i> ${display}`;
        item.onclick = () => {
            if (type === 'category') navigateToFrases(value);
            else { 
                dom.searchBar.value = ''; 
                clearSuggestions(); 
                listaAtualParaLeitura = [fullData];
                openReaderMode(0);
            }
        };
        dom.suggestionsBox.appendChild(item);
    }

    function clearSearch() {
        dom.searchBar.value = '';
        clearSuggestions();
        showCategoriasGrid(); 
    }
    
    function clearSuggestions() {
        dom.suggestionsBox.innerHTML = '';
        dom.suggestionsBox.style.display = 'none';
        dom.clearSearchBtn.style.display = 'none';
    }

    // --- RENDERIZAÇÃO DE CARDS ---
    
    
    function renderCategoriasGrid(data) {
        const catMap = new Map(); 
        
        console.log("Dados recebidos para o grid:", data); // Verifique o console (F12)

        data.forEach(s => {
            // Tenta pegar a categoria de qualquer jeito (Maiúscula ou Minúscula)
            const cat = s.Categoria || s.categoria;
            const desc = s.Descricao || s.descricao || "Histórias encantadoras.";

            if (!cat) return; // Pula se não tiver categoria

            const catLimpa = cat.trim();
            if (!catMap.has(catLimpa)) {
                catMap.set(catLimpa, { total: 1, desc: desc });
            } else {
                catMap.get(catLimpa).total++;
            }
        });

        allCategories = Array.from(catMap.keys()).sort();
        dom.grid.innerHTML = '';
        
        if (allCategories.length === 0) {
            dom.grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 20px;">Nenhuma categoria encontrada. Verifique se o campo "Categoria" existe no seu JSON.</p>';
            return;
        }

        allCategories.forEach(nome => {
            const info = catMap.get(nome);
            const card = document.createElement('div');
            card.className = 'categoria-card ripple';
            card.innerHTML = `
                <div class="card-img-fundo" style="background-image: url('${imgMap[nome] || imgMap.default}')"></div>
                <div class="card-overlay"></div>
                <span class="categoria-contador">${info.total}</span>
                <div class="card-info">
                    <i class="${iconMap[nome] || iconMap.default}"></i>
                    <p>${nome}</p>
                    <small>${info.desc}</small>
                </div>
            `;
            card.onclick = (e) => { 
                applyRippleEffect(e); 
                navigateToFrases(nome); 
            };
            dom.grid.appendChild(card);
        });
    }

    function renderStoryCard(item, index) {
    const card = document.createElement('div');
    card.className = 'frase-card ripple';
    
    // Abre a história ao clicar no card, exceto se clicar nos botões de ação
    card.onclick = (e) => {
        if (!e.target.closest('.frase-acoes')) {
            openReaderMode(index);
        }
    };
    
    const categoriaNome = item.Categoria || item.categoria || "História";
    const titulo = item.Titulo || item.titulo || "História sem Título";
    const autor = item.Autor || item.autor || "Autor desconhecido";
    const data = item.Data || item.data || "";
    const resumo = (item.Texto || item.texto || "").substring(0, 100) + "...";
    
    const isFav = isFavorited(item);

    card.innerHTML = `
        <div style="pointer-events: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span class="frase-badge-categoria">
                    <i class="${iconMap[categoriaNome] || 'fas fa-book'}"></i> ${categoriaNome}
                </span>
                <span style="font-size: 0.75rem; opacity: 0.5;">${data}</span>
            </div>
            <h3 style="color: var(--cor-destaque); font-size: 1.3rem; margin-bottom: 5px;">${titulo}</h3>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 12px; font-style: italic;">— ${autor}</p>
            <p style="font-size: 1rem; line-height: 1.4; opacity: 0.9;">${resumo}</p>
            
            <div style="margin-top: 15px; text-align: right; color: var(--cor-destaque); font-weight: bold; font-size: 0.8rem;">
                Ler mais... <i class="fas fa-chevron-right"></i>
            </div>
        </div>

        <div class="frase-acoes" style="margin-top: 15px; border-top: 1px solid var(--cor-glass-borda); padding-top: 10px; display: flex; justify-content: space-around;">
            <button class="btn-acao ripple" onclick="handleCopiar(\`${(item.Texto || item.texto).replace(/`/g, "'")}\`, event)" title="Copiar">
                <i class="fas fa-copy"></i>
            </button>
            
            <button class="btn-acao btn-favoritar ripple ${isFav ? 'favoritado' : ''}" 
                onclick="handleFavoritar(${JSON.stringify(item).replace(/"/g, '&quot;')}, event)" title="Favoritar">
                <i class="fas fa-heart"></i>
            </button>
            
            <button class="btn-acao ripple" onclick="handlePartilhar(\`${(item.Texto || item.texto).replace(/`/g, "'")}\`, event)" title="Compartilhar">
                <i class="fas fa-share-alt"></i>
            </button>
        </div>
    `;
    return card;
}

    // --- MODO LEITURA (SWIPE) ---
    
    
    
    
    function openReaderMode(index) {
    // Validação de limites para evitar que o swipe quebre no início/fim da lista
    if (index < 0 || index >= listaAtualParaLeitura.length) return;

    const item = listaAtualParaLeitura[index];
    if (!item) return;
    
    addToHistorico(item);

    const categoriaNome = item.Categoria || item.categoria || "default";
    const imagemBanner = imgMap[categoriaNome] || imgMap['default'];
    const textoCompleto = item.Texto || item.texto || "";
    
    let currentFontScale = parseFloat(localStorage.getItem('reader-font-scale')) || 1.0;
    let currentTheme = localStorage.getItem('reader-theme') || 'default';

    const reader = document.createElement('div');
    // Adicionei a classe 'active' para controle de animação de entrada via CSS
    reader.className = `reader-mode theme-${currentTheme} active`;
    document.body.style.overflow = 'hidden';
    
    // Tratamento para evitar que aspas e caracteres especiais quebrem os atributos HTML
    const textoParaAcoes = textoCompleto.replace(/`/g, "\\`").replace(/\$/g, "\\$");
    const itemString = JSON.stringify(item).replace(/"/g, '&quot;');
    
    reader.innerHTML = `
        <div class="reading-progress-container"><div class="reading-progress-bar" id="progressBar"></div></div>

        <div class="reader-fixed-header" id="readerHeader">
            <div class="reader-banner" style="background-image: url('${imagemBanner}')"></div>
            <button class="reader-close" onclick="closeReader()"><i class="fas fa-times"></i></button>
            <span class="reader-counter">${index + 1} / ${listaAtualParaLeitura.length}</span>
            <div style="text-align: center; padding: 0 20px; position: relative; z-index: 10;">
                <h1 style="color: var(--cor-destaque); font-size: 1.8rem; margin-top: -20px; margin-bottom: 5px;">${item.Titulo || "Sem Título"}</h1>
                <p style="font-weight: 700; opacity: 0.6; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    ${item.Autor || 'Anônimo'} ${item.Data ? '• ' + item.Data : ''}
                </p>
            </div>
        </div>

        <div class="reader-popup" id="fontPopup">
            <button class="btn-font-control" onclick="adjustFontSize(-0.1, event)"><i class="fas fa-minus"></i></button>
            <span class="font-size-indicator" id="fontSizeLabel">${Math.round(currentFontScale * 100)}%</span>
            <button class="btn-font-control" onclick="adjustFontSize(0.1, event)"><i class="fas fa-plus"></i></button>
        </div>

        <div class="reader-popup" id="themePopup">
            <div class="btn-theme-dot" style="background:#ffffff; border: 1px solid #ddd;" onclick="setReaderTheme('default', event)"></div>
            <div class="btn-theme-dot" style="background:#f4ecd8" onclick="setReaderTheme('sepia', event)"></div>
            <div class="btn-theme-dot" style="background:#121212" onclick="setReaderTheme('dark', event)"></div>
        </div>

        <div class="reader-content-scroll" id="scrollArea">
            <div class="reader-story-body" style="font-size: ${1.35 * currentFontScale}rem; text-align: center;">
                ${textoCompleto.replace(/\n/g, '<br><br>')}
                <div style="height: 120px;"></div> </div>
        </div>

        <div class="reader-actions" id="readerActions">
            <button class="btn-reader-acao" onclick="togglePopup('fontPopup', event)"><i class="fas fa-font"></i></button>
            <button class="btn-reader-acao" onclick="togglePopup('themePopup', event)"><i class="fas fa-palette"></i></button>
            <button class="btn-reader-acao" onclick="handleCopiar(\`${textoParaAcoes}\`, event)"><i class="fas fa-copy"></i></button>
            <button class="btn-reader-acao ${isFavorited(item) ? 'fav-active' : ''}" id="fav-reader-btn" onclick="handleFavoritarReader(${itemString}, event)">
                <i class="fas fa-heart"></i>
            </button>
            <button class="btn-reader-acao" onclick="handlePartilhar(\`${textoParaAcoes}\`, event)"><i class="fas fa-share-alt"></i></button>
        </div>
    `;

    document.body.appendChild(reader);

    const scrollArea = reader.querySelector('#scrollArea');
    const header = reader.querySelector('#readerHeader');
    const actions = reader.querySelector('#readerActions');
    const progressBar = reader.querySelector('#progressBar');
    let lastScroll = 0;

    // Lógica de Scroll - Esconder/Mostrar UI
    scrollArea.addEventListener('scroll', () => {
        const winScroll = scrollArea.scrollTop;
        const height = scrollArea.scrollHeight - scrollArea.clientHeight;
        progressBar.style.width = (winScroll / height * 100) + "%";

        if (winScroll > lastScroll && winScroll > 100) {
            header.classList.add('ui-hidden'); 
            actions.classList.add('ui-hidden-actions');
            closeAllPopups();
        } else {
            header.classList.remove('ui-hidden'); 
            actions.classList.remove('ui-hidden-actions');
        }
        lastScroll = winScroll;
    });

    // Clique no conteúdo para alternar barras
    scrollArea.addEventListener('click', (e) => {
        if (e.target.closest('.reader-story-body')) {
            header.classList.toggle('ui-hidden'); 
            actions.classList.toggle('ui-hidden-actions');
            closeAllPopups();
        }
    });

    // --- Controles Globais do Reader ---
    window.togglePopup = function(id, e) {
        e.stopPropagation();
        const target = document.getElementById(id);
        const isOpen = target.classList.contains('show');
        closeAllPopups();
        if(!isOpen) {
            target.classList.add('show');
            triggerHapticFeedback(10);
        }
    };

    window.closeAllPopups = () => document.querySelectorAll('.reader-popup').forEach(p => p.classList.remove('show'));

    window.adjustFontSize = function(delta, e) {
        e.stopPropagation();
        currentFontScale = Math.max(0.7, Math.min(2.0, currentFontScale + delta));
        reader.querySelector('.reader-story-body').style.fontSize = (1.35 * currentFontScale) + 'rem';
        document.getElementById('fontSizeLabel').innerText = Math.round(currentFontScale * 100) + '%';
        localStorage.setItem('reader-font-scale', currentFontScale);
        triggerHapticFeedback(5);
    };

    window.setReaderTheme = function(theme, e) {
        e.stopPropagation();
        reader.classList.remove('theme-default', 'theme-sepia', 'theme-dark');
        reader.classList.add('theme-' + theme);
        localStorage.setItem('reader-theme', theme);
        triggerHapticFeedback(25);
    };

    // --- Navegação Inteligente (Swipe Horizontal) ---
    let xDown = null;
    let yDown = null;

    scrollArea.ontouchstart = e => {
        xDown = e.touches[0].clientX;
        yDown = e.touches[0].clientY;
    };

    scrollArea.ontouchend = e => {
        if (!xDown || !yDown) return;
        let xUp = e.changedTouches[0].clientX;
        let yUp = e.changedTouches[0].clientY;
        let xDiff = xDown - xUp;
        let yDiff = yDown - yUp;

        // Se o movimento horizontal for maior que o vertical, é um swipe de navegação
        if (Math.abs(xDiff) > Math.abs(yDiff) && Math.abs(xDiff) > 80) {
            if (xDiff > 0 && index < listaAtualParaLeitura.length - 1) {
                closeReader();
                setTimeout(() => openReaderMode(index + 1), 50);
                triggerHapticFeedback(40);
            } else if (xDiff < 0 && index > 0) {
                closeReader();
                setTimeout(() => openReaderMode(index - 1), 50);
                triggerHapticFeedback(40);
            }
        }
        xDown = null; yDown = null;
    };
}


// Função auxiliar para favoritar dentro do reader (Modo Leitura)

window.handleFavoritarReader = function(item, e) {
    // 1. Alterna o estado de favorito no banco de dados (localStorage)
    const agoraFav = toggleFavorite(item); 
    
    // 2. Atualiza visualmente o botão dentro do Reader
    const btn = document.getElementById('fav-reader-btn');
    if (btn) {
        const icone = btn.querySelector('i');
        btn.classList.toggle('fav-active', agoraFav);
        if (icone) {
            icone.className = agoraFav ? 'fas fa-heart' : 'far fa-heart';
        }
    }
    
    // 3. Feedback tátil
    triggerHapticFeedback(agoraFav ? 50 : 20);

    /**
     * 4. ATUALIZAÇÃO DA TELA DE FUNDO
     * Substituímos renderStoryCards() pelo nome real da sua função:
     */
    if (typeof filterAndRenderFrasesOnPage === 'function') {
        // Chamamos sem argumentos para apenas re-renderizar a lista atual
        filterAndRenderFrasesOnPage(); 
    } else {
        console.warn("Função de renderização da página não encontrada.");
    }
};

window.closeReader = function() {
    const r = document.querySelector('.reader-mode');
    if (r) {
        r.style.opacity = '0';
        r.style.transform = 'translateY(20px)';
        setTimeout(() => {
            r.remove();
            document.body.style.overflow = '';
        }, 300);
    }
};

// --- LÓGICA DE AÇÕES NO CARD ---

function handleCopiar(txt, e) {
    if(e) e.stopPropagation();
    
    navigator.clipboard.writeText(txt).then(() => {
        window.CustomModal.show({
            titulo: "Copiado!",
            mensagem: "A história foi copiada para sua área de transferência.",
            icone: "fa-check-circle"
        });
        triggerHapticFeedback(50);
    });
}

function handleFavoritar(item, e) {
    if(e) e.stopPropagation();
    const agoraFav = toggleFavorite(item);
    
    // Atualiza o visual do botão que foi clicado
    const btn = e.currentTarget;
    btn.classList.toggle('favoritado', agoraFav);
    const icone = btn.querySelector('i');
    if(icone) icone.className = agoraFav ? 'fas fa-heart' : 'far fa-heart';
    
    triggerHapticFeedback(agoraFav ? 50 : 20);
}

function handlePartilhar(txt, e) {
    if(e) e.stopPropagation();
    if (navigator.share) {
        navigator.share({ 
            title: 'História do Coração', 
            text: txt,
            url: window.location.href 
        }).then(() => triggerHapticFeedback(40))
          .catch(() => {});
    } else {
        handleCopiar(txt); // Fallback se não houver suporte a partilha
    }
}

    
    function filterAndRenderFrasesOnPage(cat = null, query = null) {
    // Filtro inteligente (normalizando chaves do JSON)
    if (cat) {
        listaAtualParaLeitura = allFrasesData.filter(s => (s.Categoria || s.categoria) === cat);
    } else if (query) {
        const q = query.toLowerCase();
        listaAtualParaLeitura = allFrasesData.filter(s => {
            const txt = (s.Texto || s.texto || "").toLowerCase();
            const tit = (s.Titulo || s.titulo || "").toLowerCase();
            return txt.includes(q) || tit.includes(q);
        });
    }
    
    dom.listaFrases.innerHTML = '';
    
    if (listaAtualParaLeitura.length === 0) {
        dom.listaFrases.innerHTML = `
            <div class="empty-state" style="text-align:center; padding:60px 20px; opacity:0.5;">
                <i class="fas fa-ghost" style="font-size:4rem; margin-bottom:15px; color:var(--cor-destaque);"></i>
                <h3 style="margin-bottom:5px;">Nada por aqui...</h3>
                <p>Nenhuma história corresponde à sua busca.</p>
            </div>`;
    } else {
        // Renderiza com pequena animação de delay entre cards
        listaAtualParaLeitura.forEach((s, i) => {
            const card = renderStoryCard(s, i);
            card.style.animationDelay = `${i * 0.05}s`;
            dom.listaFrases.appendChild(card);
        });
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function setLayout(mode) {
    currentLayout = mode;
    localStorage.setItem(KEY_LAYOUT, mode);
    
    // Transição suave de layout
    dom.listaFrases.style.opacity = '0';
    setTimeout(() => {
        dom.listaFrases.className = mode === 'grid' ? 'lista-historias mode-grid' : 'lista-historias mode-list';
        dom.listaFrases.style.opacity = '1';
    }, 200);

    document.getElementById('btn-layout-list').classList.toggle('active', mode === 'list');
    document.getElementById('btn-layout-grid').classList.toggle('active', mode === 'grid');
    triggerHapticFeedback(15);
}

function showRandomStory() {
    const rand = Math.floor(Math.random() * allFrasesData.length);
    listaAtualParaLeitura = [allFrasesData[rand]]; // Foca apenas na sorteada
    openReaderMode(0); // Abre o reader no primeiro (e único) item da lista atual
    triggerHapticFeedback(70);
}

    // --- INICIALIZAÇÃO ---
    
    async function loadApp() {
        try {
            const res = await fetch(HISTORIAS_URL);
            allFrasesData = await res.json();
            renderCategoriasGrid(allFrasesData);
            setLayout(currentLayout);
        } catch (e) { console.error("Erro ao carregar histórias", e); }
    }

    dom.searchBar.addEventListener('input', (e) => updateSuggestions(e.target.value));
    dom.clearSearchBtn.onclick = clearSearch;
    document.getElementById('btn-random').onclick = showRandomStory;

    document.addEventListener('DOMContentLoaded', () => { loadSettings(); loadApp(); });
    </script>
</body>
</html>